@using Microsoft.AspNetCore.Routing
@using Pelo.v2.Web.Models.Invoice
@using Pelo.v2.Web.Models.Datatables
@using Pelo.v2.Web.Models.Datatables.Render
@model Pelo.v2.Web.Models.Invoice.InvoiceSearchModel
@{
    ViewBag.Title = "Danh sách đơn hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section cssPlugin{
    <link rel="stylesheet" href="@Url.Content("~/startui/css/lib/datatables-net/datatables.min.css")">
    <link rel="stylesheet" href="@Url.Content("~/startui/css/separate/vendor/datatables-net.min.css")">
}

@section css{
    <style>
        .box-typical.box-typical-dashboard .box-typical-body {
            height: auto !important;
        }
    </style>
}

@section jsPlugin {
    <script src="@Url.Content("~/startui/js/lib/datatables-net/datatables.min.js")"></script>
    <script src="~/startui/js/lib/moment/moment.min.js"></script>
}

<div class="row">
    <div class="col-xl-12 dahsboard-column">
        <section class="box-typical box-typical-dashboard panel panel-default scrollable">
            <header class="box-typical-header panel-heading">
                <h3 class="panel-title">Danh sách đơn hàng</h3>
            </header>
            <div class="box-typical-body panel-body">
                <div class="row" style="padding:15px;">
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="CustomerName" text-display="Tên khách hàng" />
                            <input asp-for="CustomerName" class="form-control" type="text" placeholder="Tên khách hàng" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="CustomerPhone" text-display="Số điện thoại" />
                            <input asp-for="CustomerPhone" class="form-control" type="text" placeholder="Số điện thoại" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="CustomerCode" text-display="Mã khách hàng" />
                            <input asp-for="CustomerCode" class="form-control" type="text" placeholder="Mã khách hàng" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="Code" text-display="Mã đơn hàng" />
                            <input asp-for="Code" class="form-control" type="text" placeholder="Mã đơn hàng" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="BranchId" text-display="Chi nhánh" />
                            <nop-select asp-for="BranchId" asp-items="Model.AvaiableBranches" />
                        </fieldset>
                    </div>

                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="InvoiceStatusId" text-display="Trạng thái" />
                            <nop-select asp-for="InvoiceStatusId" asp-items="Model.AvaiableInvoiceStatuses" />
                        </fieldset>
                    </div>

                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="UserCreatedId" text-display="Lên đơn" />
                            <nop-select asp-for="UserCreatedId" asp-items="Model.AvaiableUserCreateds" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="UserSellId" text-display="Nhân viên bán hàng" />
                            <nop-select asp-for="UserSellId" asp-items="Model.AvaiableUserSells" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="UserDeliveryId" text-display="Người giao" />
                            <nop-select asp-for="UserDeliveryId" asp-items="Model.AvaiableUserDeliveries" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="FromDate" text-display="Từ ngày" />
                            <input asp-for="FromDate" class="form-control" type="text" placeholder="Từ ngày" />
                        </fieldset>
                    </div>
                    <div class="col-lg-6">
                        <fieldset class="form-group">
                            <nop-label asp-for="ToDate" text-display="Đến ngày" />
                            <input asp-for="ToDate" class="form-control" type="text" placeholder="Đến ngày" />
                        </fieldset>
                    </div>
                    <div class="col-xs-12">
                        <button class="btn btn-primary" id="search-invoice">Tìm kiếm</button>
                        <a class="btn btn-success" href="@Url.Action("FindCustomer")">Thêm mới</a>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<section class="card">
    <div class="card-block">
        @await Html.PartialAsync("Table", new DataTablesModel
   {
       Name = "invoice-grid",
       UrlRead = new DataUrl("GetList", "Invoice", null),
       SearchButtonId = "search-invoice",
       Ordering = false,
       Filters = new List<FilterParameter> {
                                                   new FilterParameter(nameof(Model.CustomerCode)),
                                                   new FilterParameter(nameof(Model.CustomerName)),
                                                   new FilterParameter(nameof(Model.CustomerPhone)),
                                                   new FilterParameter(nameof(Model.InvoiceStatusId)),
                                                   new FilterParameter(nameof(Model.Code)),
                                                   new FilterParameter(nameof(Model.BranchId)),
                                                   new FilterParameter(nameof(Model.UserSellId)),
                                                   new FilterParameter(nameof(Model.UserDeliveryId)),
                                                   new FilterParameter(nameof(Model.FromDate)),
                                                   new FilterParameter(nameof(Model.ToDate)),
                                                   new FilterParameter(nameof(Model.UserCreatedId))
                                           },
       ColumnCollection = new List<ColumnProperty> {
                                                           new ColumnProperty(nameof(InvoiceModel.InvoiceStatus))
                                                           {
                                                                   Title = "Trạng thái",
                                                                   Width = "150",
                                                                   Render = new RenderCustom("displayInvoiceStatus")
                                                           },
                                                           new ColumnProperty(nameof(InvoiceModel.Code))
                                                           {
                                                                   Title = "Mã đơn hàng",
                                                                   Render = new RenderLink(new DataUrl("Invoice/Detail","Id"))
                                                           },
                                                           new ColumnProperty(nameof(InvoiceModel.Customer))
                                                           {
                                                                   Title = "Khách hàng",
                                                                   Render = new RenderCustom("displayCustomer")
                                                           },
                                                           new ColumnProperty(nameof(InvoiceModel.Products))
                                                           {
                                                                   Title = "Sản phẩm",
                                                                   Render = new RenderCustom("displayProduct")
                                                           },
                                                           new ColumnProperty(nameof(InvoiceModel.Branch))
                                                           {
                                                                   Title = "Chi nhánh",
                                                                   Render = new RenderCustom("displayBranch")
                                                           },
                                                           new ColumnProperty(nameof(InvoiceModel.DeliveryDate))
                                                           {
                                                                   Title = "Ngày giao",
                                                                   Width = "120",
                                                                   Render = new RenderCustom("displayDate")
                                                           }
                                                   }
   })
    </div>
</section>

@section js{
    <script>
        $(document).ready(function () {
            $('.opened').removeClass('opened');
            $('.row-active').removeClass('row-active');
            $('#liInvoices').addClass('opened');
            $('#liInvoice').addClass('row-active');
            $('.panel').lobiPanel({
                    sortable:false,
                    draggable:false,
                    resize:'none'
                });
           
            reloadDataWhenEnter('@nameof(Model.CustomerCode)');
            reloadDataWhenEnter('@nameof(Model.CustomerName)');
            reloadDataWhenEnter('@nameof(Model.CustomerPhone)');
            reloadDataWhenEnter('@nameof(Model.Code)');
            reloadDataWhenEnter('@nameof(Model.FromDate)');
            reloadDataWhenEnter('@nameof(Model.ToDate)');
            reloadDataWhenSelect('@nameof(Model.BranchId)');
            reloadDataWhenSelect('@nameof(Model.InvoiceStatusId)');
            reloadDataWhenSelect('@nameof(Model.UserSellId)');
            reloadDataWhenSelect('@nameof(Model.UserCreatedId)');
            reloadDataWhenSelect('@nameof(Model.UserDeliveryId)');
        });
        function displayInvoiceStatus(data,type,row,meta) {
            return '<div style="text-align:center;margin:auto;"><span class="label" style="width:150px;background-color:'+
                row.InvoiceStatusColor+
                '">'+
                row.InvoiceStatus+
                '</span></div>';
        }
        function displayProduct(data, type, row, meta) {
            var products = '';
            var condition='';
            if(row.Products) {
                if(row.Products.length>0) {
                    for (var i = 0; i < row.Products.length; i++) {
                        var description = '';
                        if(row.Products[i].description) {
                            description='('+row.Products[i].description+')';
                        }
                        products=products+
                            condition+
                            '<span>'+
                            row.Products[i].name+
                            ' '+
                            description+
                            '</span>';
                        condition=', ';
                    }
                }
            }
            return '<div style="padding:10px;">' + products + '</div></div>';
        }
        function displayBranch(data, type, row, meta) {
            var branch = '';
            if (isNull(row.Branch)) {
                branch = '<span>Chi nhánh: <span style="font-weight:700;">' + row.Branch + '</span></span><br/>';
            }
            var userCreated = '';

            if(isNull(row.UserCreatedPhone)) {
                userCreated='<span>Lên đơn: <span style="font-weight:700;"><a href="tel:'+
                    row.UserCreatedPhone+
                    '">'+
                    row.UserCreated+
                    '</a></span></span><br/>';
            } else {
                userCreated='<span>Lên đơn: <span style="font-weight:700;">'+
                    row.UserCreated+
                    '</span></span><br/>';
            }

            var userSell = '';

            if(isNull(row.UserSellPhone)) {
                userSell='<span>Bán hàng: <span style="font-weight:700;"><a href="tel:'+
                    row.UserSellPhone+
                    '">'+
                    row.UserSell+
                    '</a></span></span><br/>';
            } else {
                userSell='<span>Bán hàng: <span style="font-weight:700;">'+
                    row.UserSell+
                    '</span></span><br/>';
            }
            var userDeliveries = '';
            var condition='';
            if(row.UserDeliveries) {
                if(row.UserDeliveries.length>0) {
                    for(var i=0;i<row.UserDeliveries.length;i++) {
                        userDeliveries=userDeliveries+
                            condition+
                            '<a href="tel:'+
                            row.UserDeliveries[i].phone_number+
                            '">'+
                            row.UserDeliveries[i].display_name+
                            '</a>';
                        condition=', ';
                    }
                }
            }
            if(userDeliveries) {
                userDeliveries='<span>Người giao: <span style="font-weight:700;">'+userDeliveries+'</span></span><br/>';
            }
            return '<div style="padding:10px;">' + branch + userCreated + userSell + userDeliveries + '</div></div>';
        }
        function displayCustomer(data,type,row,meta) {
            var customerName = '<span style="font-weight:600;font-size:16px;">' + data + '</span><br/>';
                    var phone = '<span><a href="tel:' + row.CustomerPhone + '">' + row.CustomerPhone + '</a></span><br/>';
                    var phone2 = '';
                    if (isNull(row.CustomerPhone2)) {
                        phone2 = '<span><a href="tel:' + row.CustomerPhone2 + '">' + row.CustomerPhone2 + '</a></span><br/>';
                    }
                    var phone3 = '';
                    if (isNull(row.CustomerPhone3)) {
                        phone3 = '<span><a href="tel:' + row.CustomerPhone3 + '">' + row.CustomerPhone3 + '</a></span><br/>';
                    }
                    var address = '';
                    if(isNull(row.CustomerAddress)) {
                        address = row.CustomerAddress;
                    }
                    if(isNull(row.Province)) {
                        address=address+', '+row.Ward+', '+row.District+', '+row.Province;
                    }
                    if(isNull(address)) {
                        address = '<span>Địa chỉ: <span style="font-weight:700;">' + address + '</span></span><br/>';
                    }
                    var customerGroup='';
                    if(isNull(row.CustomerGroup)) {
                        customerGroup='<span>Nhóm khách hàng: <span style="font-weight:700;">'+
                            row.CustomerGroup+
                            '</span></span><br/>';
                    }
                    var customerVip = '';
                    if(isNull(row.CustomerVip)) {
                        customerVip='<span>Mức độ thân thiết: <span style="font-weight:700;">'+
                            row.CustomerVip+
                            '</span></span><br/>';
                    }
                    return '<div style="padding:10px;">'+
                        customerName+
                        phone+
                        phone2+
                        phone3+
                        address+
                        customerGroup+
                        customerVip+
                        '</div>';
        }
    </script>
}
